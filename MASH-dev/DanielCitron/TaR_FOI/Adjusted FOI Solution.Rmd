---
title: "Adjusted FOI solution"
author: "Daniel T. Citron"
date: "8/21/2018"
output: html_document
---
```{r}
library(MASS)
```

The model that we want to solve:
$$
\psi \cdot \vec{h} = \frac{r \vec{X}}{1 - \vec{X}}
$$
where $\vec{h}$ represents the Force of Infection, the quantity that we are solving for. 
$\psi$ is a known matrix, $\vec{X}$ is a known vector, and $r =1/200$.

This example problem will use 3 example areas.  Two of the areas are located outside of Malabo (`ban.area` and `bas.area`) while the third area is inside Malabo (`mal.area`).  The remaining 7 locations included in the model are all places where people travel to.
```{r Read in Movement Model Data}
P.ij <- read.csv( "pij.csv",
               col.names = c("x","ban.area", "mal.area", "bas.area", "off", "ban", "lub", "mal", "mok", "ria", "ure"),
               row.names = c("ban.area", "mal.area", "bas.area", "off", "ban", "lub", "mal", "mok", "ria", "ure"))
P.ij <- P.ij[,2:11]
```
Each row of `P.ij` represents a probability distribution - the amount of time spent distributed across the 10 different locations included in this example.

Define vector of PR estimates
```{r Defining the PR Estimates}
X.est <- c(0.17300000, 0.15575000, 0.20550000, # example areas
           0.50000000, 0.10624307, 0.10887395, 0.15729471, 0.01386838, 0.12828326, 0.17975000 # regions
           )
X.est <- as.matrix(X.est)
```

And the last parameter for the model:
```{r Parameter r}
r = 1/200
```


Solving by inverting, assuming that all elements of $\psi$ are fixed and no elements of $h$ are fixed
```{r Solving by inverting}
g <- r*X.est/(1-X.est)
h <- ginv(as.matrix(P.ij)) %*% g
h
```

The problem now is that we actually have too much FOI in the Malabo-related areas.  
$$ 
h = bEIR = VC*(\text{sporozoite rate}) \propto \frac{M}{H}
$$
If we assume that the sporozoite rate is roughly the same everywhere (which I have not actually checked yet), we find that the force of infection is proportional to the mosquito population divided by the human population.

In the areas associated with Malabo, empirical studies find that there really aren't very many mosquitoes and a large number of humans. In other words, the estimates of $h$ in Malabo are far too high.

For the sake of this example, let's impose a few conditions on the two elements of $h$.  $h_2$ is the FOI associated with the example area in Malabo, so we might say the following:
$$
\frac{h_1}{h_3} \ge 100, \qquad \qquad \frac{h_3}{h_2} \ge 100
$$
$h_7$ is the FOI asociated with the destination region of Malabo, so we might also say the following:
$$
\frac{h_5 + h_6 + h_8 + h_9 + h_{10}}{5}/h_7 \ge 100
$$
Note that the constants on the right hand sides of these inequalities are equal to 100, but in practice can be set according to HLC data.


We have added two additional constraints to what the values of $h$ can be, so we also allow certain elements of $\psi$ to vary.  Currently, the $3\times3$ upper-left-hand block of $\psi$, representing the interactions between the three example areas, is defined like this:
```{r}
P.ij[1:3, 1:3]
```

We want to adjust this to allow people in `mal.area` to move around to `ban.area` and `bas.area`:
$$
  \hat{\psi} = \left( {\begin{array}{ccc}
   0.9805047 & 0.0000000 & 0.0000000 \\
   \delta_1 & 0.9818041 - \delta_1 - \delta_2 & \delta_2 \\
    0.0000000 & 0.0000000 & 0.9867172 \\
  \end{array} } \right)
$$
Simultaneously, we need to have the rows of $\hat{\psi}$ remain normalized.

## To summarize 

We are left with 12 free parameters to fit:
  
  * $\delta_1$ and $\delta_2$, 2 parameters from $\hat{\psi}$ 
  * $\vec{h}$, a 10-element vector
  
We have some constraints on these parameters.  We want to constrain $h_2$ and $h_7$ to be small compared to the other elements of $\vec{h}$

  * $h_1 \ge 100 h_2$
  * $h_3 \ge 100 h_2$
  * $\frac{h_5 + h_6 + h_8 + h_9 + h_{10}}{5} \ge 100 h_7$

There are also some constraints on $\delta_1$ and $\delta_2$, simply because each row of $\hat{\psi}$ represents a probability distribution.

  * $0.9818041 - \delta_1 - \delta_2 \ge 0$
  * $\delta_1 \ge 0$
  * $\delta_2 \ge 0$
  
Re-arranging our model, we can solve for the _odds_ of being PR positive:
$$
r \frac{\hat{X}}{1 - \hat{X}} = \hat{\psi} \cdot \vec{h}
$$
Our objective is to find $\hat{X}$ that comes as close to possible to estimating our PR estimates $\vec{X}$.