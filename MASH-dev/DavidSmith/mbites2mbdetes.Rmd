---
title: "MBITES/MBDETES :: Surivival through / Length of the Feeding Cycle"
author: "David L Smith"
date: "6/8/2018"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background

Under some restricted conditions on waiting times, MBITES is what we would get if we translated MBDETES into a stochastic model, under the Gillespie algorithm. We can, therefore, use MBDETES to compute expectations for MBITES under these same contitions. 

The utility **mbites2mbdetes** outputs state transitions, with outputs denoted as described in the following. The interval between leaving the post-prandial resting state, $R$ can be computed from the state transition probabilities. Let $P_{X,Y}$ denote the probability of making a transition from state $X$ to state $Y$, and $t_{X}$ the average time spent in $X$. Note that there is always an implied $P_{X,D}$, a transition to death such that $$\sum_{Y\neq D}P_{X,Y} =1-P_{X,D}.$$ 

### Without Search 

First, to build up the following derivations in a stepwise fashion, we ignore search. Without search, there are two paths out of $R$: refeeding and egg laying, which happen with probability $P_{R,B}$ and $P_{R,O}$. 

The state transitions from $B$ are $B\rightarrow {B,R,D}$. Since we allow $P_{B,B}$, the overall probability of going from $B$ to $R$ (i.e. rather than die, with probability $P_{B,D} = 1-P_{B,B}-P_{B,R}$) is 
$$\hat P_{B,R} = P_{B,R} + P_{B,B} \hat P_{B,R} = \frac{P_{B,R}}{1-P_{B,B}}.$$ We get the rhs of the last "=" by solving for $\hat P_{B,R}$ on the equations to the left of it.  
The  expected waiting time: 
$$T_{B,R}\left( P_{B,R} + P_{B,B} \right) = P_{B,R} t_B + P_{B,B} T_{B,R} $$ 
$$ T_{B,R} = \frac{P_{B,R} t_B}{P_{B,R} + P_{B,B}-P_{B,B}} = t_B.$$

Similarly, the state transitions from $O$ are $B\rightarrow {O,B,D}$, so the overall probability of going from $O$ to $B$ is: 
$$\hat P_{O,B} = P_{O,B} + P_{O,O} \hat P_{O,B} = \frac{P_{O,B}}{1-P_{O,O}},$$ 
with expected waiting time: 

$$T_{O,B} \left(P_{O,B} + P_{O,O}\right) = P_{O,B} t_O + P_{O,O} T_{O,B}$$

$$T_{O,B} = \frac{t_O}{P_{O,B} + P_{O,O}-P_{O,O}} = t_O.$$

So the probability of surviving from $R$ back to $R$ is:
$$\hat P_{R,R} = P_{R,B} \hat P_{B,R} + P_{R,O} \hat P_{O,B} \hat P_{B,R}$$
And expected the waiting time is:
$$T_{R,R} \left( P_{R,B}+P_{R,O} \right) = P_{R,B} \hat P_{B,R} T_{R,B} + P_{R,O} \hat P_{O,B} \hat P_{B,R}\left(T_{O,B} +  T_{R,B}\right)$$
$$T_{R,R} \left( P_{R,B}+P_{R,O} \right) = \frac{P_{R,B}}{P_{R,B}+P_{R,O}} \hat P_{B,R} T_{R,B} + \frac{P_{R,O}}{P_{R,B}+P_{R,O}} \hat P_{O,B} \hat P_{B,R}\left(T_{O,B} +  T_{R,B}\right)$$

### With Search

With search, we can consider these same paths from $R$ back to $R$ but with the more complicated problem of having repeated attempts to search before successfully completing an attempt. 

The state transitions from $F$ are  $F\rightarrow {F,B,D}$, and from $B$ are $B\rightarrow {F,B,R,D}$. The overall probability of going from $F$ to $B$ is: 
$$\hat P_{F,B}= P_{F,B} + P_{F,F} \hat P_{F,B} = \frac{P_{F,B}}{1-P_{F,F}}$$
with waiting time: 
$$T_{F,B} \left(P_{F,F} + P_{F,B}\right) = P_{F,B} t_B + P_{B,B} T_{F,B}$$
$$T_{F,B} = \frac{P_{F,B} t_F}{P_{F,F} + P_{F,B}-P_{F,F}} = t_F$$ 

```{r}
hatF2B = function(F2B, F2F){F2B/(1-F2F)}
```

The overall probability of going from $B$ to $R$ is: 
$$\hat P_{B,R} = P_{B,R} + \left(P_{B,B} + P_{B,F} \hat P_{F,B} \right) \hat P_{B,R}$$

$$ \hat P_{B,R} = \frac{P_{B,R}}{1-P_{B,B} - P_{B,F} \hat P_{F,B}} = \frac{P_{B,R}}{1-P_{B,B} - \frac{P_{B,F} P_{F,B}}{1-P_{F,F}}} $$

and: 
$$ 
T_{B,R} \left( P_{B,R} + P_{B,B}+ P_{B,F} \right)= P_{B,R} t_B + P_{B,B} T_{B,R} + P_{B,F} \hat P_{B,F} \left(t_F +  T_{B,R} \right) 
$$


$$
T_{B,R} = \frac{P_{B,R}  t_B + P_{B,F} \hat P_{B,F} t_F}{ P_{B,R} + P_{B,B}+ P_{B,F} -P_{B,B} - P_{B,F} \hat P_{F,B}} =  \frac{P_{B,R}  t_B + P_{B,F} \hat P_{B,F} t_F}{ P_{B,R} + P_{B,F}  - P_{B,F} \hat P_{F,B}}
$$




```{r}
hatB2R = function(F2F,F2B,B2F,B2B,B2R){
  B2R/(1-B2B-B2F*hatF2B(F2F,F2B))
}

TB2R = function(tF,tB,F2F,F2B,B2F,B2B,B2R){
  (B2R*tB+B2F*hatF2B(F2F,F2B)*tF)/
  (B2R+B2F-B2F*hatF2B(F2F,F2B))
}
```


Similarly, the state transitions from $L$ are  $L \rightarrow {L,O,D}$, and from $O$ are $B\rightarrow {F,L,O,B,D}$.

The overall probability of going from $L$ to $O$ is:
$$\hat P_{L,O}= P_{L,O} + P_{L,L} \hat P_{L,O} = \frac{P_{L,O}}{1-P_{L,L}}$$
with waiting time: 
$$T_{L,O} \left(P_{L,O} + P_{O,O}\right)  = P_{L,O}t_L + P_{L,L} T_{L,O} $$ 
$$T_{L,O} = \frac{t_L}{P_{L,O} + P_{O,O}-P_{L,L}}=t_L$$

```{r}
hatL2O = function(L2L, L2O){L2O/(1-L2L)}
```

The probability of going from $O$ to $F$ or $B$ is:
$$\hat P_{O,F|B} = P_{O,F} + P_{O,B} + \left(P_{O,O} + P_{O,L} \hat P_{L,O} \right) \hat P_{O,F|B} $$



$$ \hat P_{O,F|B} = \frac{P_{O,F}+ P_{O,B}}{1-P_{O,O} - P_{O,L} P_{L,O}} \\= \frac{ P_{O,F} + P_{O,B}}{1-P_{O,O} -  \frac{P_{O,L} P_{L,O}}{1-P_{L,L}}} $$

and: 
$$ T_{O,F|B} \left( P_{O,F} + P_{O,B} + P_{O,O} + P_{O,L}\right) = \left( P_{O,F} + P_{O,B} \right) t_O + P_{O,O} T_{O,F|B} + P_{O,L} \hat P_{L,O} \left(t_L + T_{O,F|B} \right)$$

$$ T_{O,F|B}= \frac{\left( P_{O,F} + P_{O,B} \right) t_O + P_{O,L} \hat P_{O,L} t_L}{P_{O,F} + P_{O,B}  + P_{O,L} - P_{O,L} \hat P_{O,L}}
$$

```{r}
hatO2F = function(L2L,L2O,O2F,O2L,O2O){
  O2F/(1-O2O-O2L*hatL2O(L2L,L2O))
}

hatO2B = function(L2L,L2O,O2F,O2L,O2O){
  O2B/(1-O2O-O2L*hatL2O(L2L,L2O))
}

TO2F = function(tF,tO,L2L,L2O,O2F,O2L,O2O){
  (O2F*tO + O2L*hatL2O(L2L,L2O)*tL)/
  (O2F+O2B+O2L-O2L*hatL2O(L2L,L2O))
}

TO2B = function(tF,tO,O2B,O2O,O2F,F2O,F2F){
  (O2B*tO + O2L*hatL2O(L2L,L2O)*tL)/
   (O2F+O2B+O2L-O2L*hatL2O(L2L,L2O))
}
```

### The Length of a Feeding Cycle

We thus have: 
$$T_{R,R} = \sum_{X \in \left\{F,B,L,O\right\}} P_{R,X} \hat P_{X,R} T_{X,R} $$
and survival through a full feeding cycle is: 
$$\hat P_{R,R} = \sum_{X \in \left\{F,B,L,O\right\}} P_{R,X} \hat P_{X,R}$$

```{r}

hatF2R = function(F2B,F2F,B2F,B2B,B2R){
  hatF2B(F2B,F2F)*hatB2R(F2B,F2F,B2F,B2B,B2R)
} 

TF2R = function(tF,tB,F2B,F2F,B2F,B2B,B2R){
  tF + TR2B(tF,tB,F2B,F2F,B2F,B2B,B2R)
}

hatO2R = function(F2B,F2F,B2F,B2B,B2R,L2L,L2O,O2F,O2B,O2L,O2O){
  hatO2F(L2L,L2O,O2F,O2B,O2L,O2O)*hatF2R(F2B,F2F,B2F,B2B,B2R)+ 
  hatO2B(L2L,L2O,O2F,O2B,O2L,O2O)*hatB2R(F2B,F2F,B2F,B2B,B2R)
}

TO2R = function(tF,tB,tO,tL,F2B,F2F,B2F,B2B,B2R,L2L,L2O,O2F,O2B,O2L,O2O){
  (hatO2F*(TO2F(tO,tL,L2L,L2O,O2F,O2B,O2L,O2O)+TF2R(tF,tB,F2B,F2F,B2F,B2B,B2R))+ 
  hatO2B*(TO2B(tO,tL,L2L,L2O,O2F,O2B,O2L,O2O)+TB2R(tF,tB,F2B,F2F,B2F,B2B,B2R)))/
  (hatO2F+hatO2B)
}

TL2R = function(tF,tB,tO,tL,F2B,F2F,B2F,B2B,B2R,L2L,L2O,O2F,O2B,O2L,O2O){
  tL+TO2R(tF,tB,tO,tL,F2B,F2F,B2F,B2B,B2R,L2L,L2O,O2F,O2B,O2L,O2O)
}

hatR2R = function(F2B,F2F,B2F,B2B,B2R,R2F,R2B,R2L,R2O,L2L,L2O,O2F,O2B,O2L,O2O){
  R2F*hatF2R(F2B,F2F,B2F,B2B,B2R)+
  R2B*hatB2R(F2B,F2F,B2F,B2B,B2R)+
  R2F*hatF2R(F2B,F2F,B2F,B2B,B2R,L2L,L2O,O2F,O2B,O2L,O2O)+
  R2O*hatO2R(F2B,F2F,B2F,B2B,B2R,L2L,L2O,O2F,O2B,O2L,O2O)
}

TR2R = function(tF,tB,tR,tO,tL,F2B,F2F,B2F,B2B,B2R,R2F,R2B,R2L,R2O,L2L,L2O,O2F,O2B,O2L,O2O){
  (tR + 
  R2F*TF2R(tF,tB,F2B,F2F,B2F,B2B,B2R)+
  R2B*TB2R(tF,tB,F2B,F2F,B2F,B2B,B2R)+
  R2L*TL2R(tF,tB,tO,tL,F2B,F2F,B2F,B2B,B2R,L2L,L2O,O2F,O2B,O2L,O2O)+
  R2O*TO2R(tF,tB,tO,tL,F2B,F2F,B2F,B2B,B2R,L2L,L2O,O2F,O2B,O2L,O2O))/ 
  (R2F+R2B+R2L+R2O) 
}
```


